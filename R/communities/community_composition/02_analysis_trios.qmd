---
title: "Analysis of trio competition"
author: "Shane Hogle"
date: today
link-citations: true
abstract: "Here we analyze the community outpcomes from all competing species trios."
---

# Setup

## Libraries

```{r}
#| output: false
library(tidyverse)
library(here)
library(fs)
library(scales)
library(ggtern)
source(here::here("R", "communities", "community_composition", "utils_community_composition.R"))
```

## Global variables

```{r}
data <- here::here("data", "communities")
# make processed data directory if it doesn't exist
fs::dir_create(data)
```

# Read data

## Species abundances

```{r}
#| output: false
samp_trios <- readr::read_tsv(here::here(data, "3sps_compiled.tsv")) %>% 
  dplyr::rename(f = f_thresh)
```

# Format

Create a metadata tibble that contains faceting information

```{r}
md <- samp_trios %>% 
  dplyr::select(sample, strainID, evo_hist, target_f_masterplate) %>% 
  # make a combined evolution and species identifier and extract the community ID
  dplyr::mutate(strainID = paste0("H", str_extract(strainID, "\\d+"))) %>% 
  dplyr::group_by(sample) %>% 
  dplyr::mutate(n = 1:n()) %>% 
  ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sample), values_from = c(strainID, evo_hist, target_f_masterplate), names_from = n) %>% 
  mutate(sps = paste(strainID_1, strainID_2, strainID_3, sep = "-"),
         f0 = paste(target_f_masterplate_1, target_f_masterplate_2, target_f_masterplate_3, sep = "-"),
         hist = paste(evo_hist_1, evo_hist_2, evo_hist_3, sep = "|")) %>% 
  dplyr::select(sample, sps, f0, hist)
```

Combine into a final tibble

```{r}
t0 <- samp_trios %>% 
  dplyr::filter(community_type == "masterplate") %>% 
  dplyr::select(-strep_conc, -replicate) %>% 
  full_join(tibble(transfers = c(0, 0, 0, 0), strep_conc = c(0, 16, 64, 256)),
            by = join_by(transfers),
            relationship = "many-to-many")

t8 <- samp_trios %>% 
  dplyr::filter(community_type == "experiment")

tf <- bind_rows(t0, t8) %>% 
  left_join(md, by = join_by(sample)) %>% 
  dplyr::summarize(ggplot2::mean_cl_boot(f),
                    .by = c("sps", "f0", "hist", "strep_conc", "transfers", "strainID")) %>% 
  mutate(extinct = if_else(y <= 0.01 | y >= 0.99, "extinct", "coexist")) %>% 
  nest( .by = sps)
```

# Plot 

## Trio HAMBI_0403 + HAMBI_1287 + HAMBI_1896

::: {#fig-01}
```{r}
#| fig-width: 5
#| fig-height: 9
#| warning: false
#| echo: false
trio_plot(tf$data[[1]]) +
  ggtitle("Trio HAMBI_0403 + HAMBI_1287 + HAMBI_1896")
```
Compositions of all trios with species HAMBI_0403, HAMBI_1287, and HAMBI_1896 at 4 different streptomycin concentrations (0, 16, 64, and 256 μg/ml; grid columns) and the 8 evolutionary history combinations tested (grid rows). The evolutionary histories are always in the same species order (HAMBI_0403, HAMBI_1287, HAMBI_1896). In each evolutionary history and streptomycin treatment combination there are three different starting fractions where each species is allowed to start from high abundance once and from rare twice. Points depict species relative abundance (vertical axis) at the start of the experiment and after eight 48-hour growth cycles (horizontal axis). Point crosses represent whether the species is below/above a 1%/99% threshold where it is effectively extinct/excluded all other competitors. Points are the mean over at least 2 replicates and line ranges represent confidence limits of the population mean from a basic nonparametric bootstrap. 
:::

## Trio HAMBI_0403 + HAMBI_1287 + HAMBI_1977

::: {#fig-02}
```{r}
#| fig-width: 5
#| fig-height: 9
#| warning: false
#| echo: false
trio_plot(tf$data[[2]]) +
  ggtitle("Trio HAMBI_0403 + HAMBI_1287 + HAMBI_1977")
```
Compositions of all trios with species HAMBI_0403, HAMBI_1287, and HAMBI_1977 at 4 different streptomycin concentrations (0, 16, 64, and 256 μg/ml; grid columns) and the 8 evolutionary history combinations tested (grid rows). The evolutionary histories are always in the same species order (HAMBI_0403, HAMBI_1287, HAMBI_1977). In each evolutionary history and streptomycin treatment combination there are three different starting fractions where each species is allowed to start from high abundance once and from rare twice. Points depict species relative abundance (vertical axis) at the start of the experiment and after eight 48-hour growth cycles (horizontal axis). Point crosses represent whether the species is below/above a 1%/99% threshold where it is effectively extinct/excluded all other competitors. Points are the mean over at least 2 replicates and line ranges represent confidence limits of the population mean from a basic nonparametric bootstrap. 
:::

## Trio HAMBI_0403 + HAMBI_1896 + HAMBI_1977

::: {#fig-03}
```{r}
#| fig-width: 5
#| fig-height: 10
#| warning: false
#| echo: false
trio_plot(tf$data[[3]]) +
  ggtitle("Trio HAMBI_0403 + HAMBI_1896 + HAMBI_1977")
```
Compositions of all trios with species HAMBI_0403, HAMBI_1896, and HAMBI_1977 at 4 different streptomycin concentrations (0, 16, 64, and 256 μg/ml; grid columns) and the 8 evolutionary history combinations tested (grid rows). The evolutionary histories are always in the same species order (HAMBI_0403, HAMBI_1896, HAMBI_1977). In each evolutionary history and streptomycin treatment combination there are three different starting fractions where each species is allowed to start from high abundance once and from rare twice. Points depict species relative abundance (vertical axis) at the start of the experiment and after eight 48-hour growth cycles (horizontal axis). Point crosses represent whether the species is below/above a 1%/99% threshold where it is effectively extinct/excluded all other competitors. Points are the mean over at least 2 replicates and line ranges represent confidence limits of the population mean from a basic nonparametric bootstrap. 
:::

## Trio HAMBI_1287 + HAMBI_1896 + HAMBI_1977

::: {#fig-04}
```{r}
#| fig-width: 5
#| fig-height: 10
#| warning: false
#| echo: false
trio_plot(tf$data[[4]]) +
  ggtitle("Trio HAMBI_1287 + HAMBI_1896 + HAMBI_1977")
```
Compositions of all trios with species HAMBI_1287, HAMBI_1896, and HAMBI_1977 at 4 different streptomycin concentrations (0, 16, 64, and 256 μg/ml; grid columns) and the 8 evolutionary history combinations tested (grid rows). The evolutionary histories are always in the same species order (HAMBI_1287, HAMBI_1896, HAMBI_1977). In each evolutionary history and streptomycin treatment combination there are three different starting fractions where each species is allowed to start from high abundance once and from rare twice. Points depict species relative abundance (vertical axis) at the start of the experiment and after eight 48-hour growth cycles (horizontal axis). Point crosses represent whether the species is below/above a 1%/99% threshold where it is effectively extinct/excluded all other competitors. Points are the mean over at least 2 replicates and line ranges represent confidence limits of the population mean from a basic nonparametric bootstrap. 
:::

# Ternary plots

```{r}
nestd4tern <- samp_trios %>% 
  mutate(strep_conc = if_else(transfers == 0, NA_real_, strep_conc)) %>% 
  rename(sp = strainID,
         f0 = target_f_masterplate) %>% 
  dplyr::group_by(sample, strep_conc) %>% 
  dplyr::mutate(n = 1:n()) %>% 
  ungroup() %>% 
  tidyr::pivot_wider(id_cols = c(sample, strep_conc, transfers, replicate), values_from = c(sp, evo_hist, f, f0), names_from = n) %>%
  mutate(f0 = paste(f0_1, f0_2, f0_3, sep = "|"),
         hist = paste(evo_hist_1, evo_hist_2, evo_hist_3, sep = "|"),
         facetrow = if_else(is.na(strep_conc), "starting", paste0(strep_conc, " μg/ml"))) %>%
  mutate(facetrow = factor(facetrow, levels = c("starting", "0 μg/ml", "16 μg/ml", "64 μg/ml", "256 μg/ml"))) %>% 
  nest(data = c(f_1, f_2, f_3, hist, f0, facetrow), .by = c(sp_1, sp_2, sp_3))
```

## Trio HAMBI_0403 + HAMBI_1287 + HAMBI_1896

::: {#fig-05}
```{r}
#| fig-width: 14
#| fig-height: 9
#| warning: false
#| echo: false
tern_plot_func(nestd4tern$data[[1]]) +
  ggtitle("Sp1 = HAMBI_0403 | Sp2 = HAMBI_1287 | Sp3 = HAMBI_1896")
```
Ternary plot for compositions of species trios with **HAMBI_0403, HAMBI_1287, HAMBI_1896** after 8 growth cycles. Grid columns represent different evolutionary history combinations for each species (same order as in title). Grid rows represent either starting concentration (first row, T0) or increasing streptomycin concentration. Point shapes represent different starting proportions in each streoptocmyinc/evolutionary history treatment.
:::

## Trio HAMBI_0403 + HAMBI_1287 + HAMBI_1977

::: {#fig-06}
```{r}
#| fig-width: 14
#| fig-height: 9
#| warning: false
#| echo: false
tern_plot_func(nestd4tern$data[[2]]) +
  ggtitle("Sp1 = HAMBI_0403 | Sp2 = HAMBI_1287 | Sp3 = HAMBI_1977")
```
Ternary plot for compositions of species trios with **HAMBI_0403, HAMBI_1287, HAMBI_1977** after 8 growth cycles. Grid columns represent different evolutionary history combinations for each species (same order as in title). Grid rows represent either starting concentration (first row, T0) or increasing streptomycin concentration. Point shapes represent different starting proportions in each streoptocmyinc/evolutionary history treatment.
:::

## Trio HAMBI_0403 + HAMBI_1896 + HAMBI_1977

::: {#fig-07}
```{r}
#| fig-width: 14
#| fig-height: 9
#| warning: false
#| echo: false
tern_plot_func(nestd4tern$data[[3]]) +
  ggtitle("Sp1 = HAMBI_0403 | Sp2 = HAMBI_1896 | Sp3 = HAMBI_1977")
```
Ternary plot for compositions of species trios with **HAMBI_0403, HAMBI_1896, HAMBI_1977** after 8 growth cycles. Grid columns represent different evolutionary history combinations for each species (same order as in title). Grid rows represent either starting concentration (first row, T0) or increasing streptomycin concentration. Point shapes represent different starting proportions in each streoptocmyinc/evolutionary history treatment.
:::

## Trio HAMBI_1287 + HAMBI_1896 + HAMBI_1977

::: {#fig-08}
```{r}
#| fig-width: 14
#| fig-height: 9
#| warning: false
#| echo: false
tern_plot_func(nestd4tern$data[[4]]) +
  ggtitle("Sp1 = HAMBI_1287 | Sp2 = HAMBI_1896 | Sp3 = HAMBI_1977")
```
Ternary plot for compositions of species trios with **HAMBI_1287, HAMBI_1896, HAMBI_1977** after 8 growth cycles. Grid columns represent different evolutionary history combinations for each species (same order as in title). Grid rows represent either starting concentration (first row, T0) or increasing streptomycin concentration. Point shapes represent different starting proportions in each streoptocmyinc/evolutionary history treatment.
:::